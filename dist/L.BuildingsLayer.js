(function(k){function O(m,o){var y=m[0]-o[0],e=m[1]-o[1];return y*y+e*e}function Ka(m){for(var o=0,y=0,e=0,h=m.length-3;e<h;e+=2){o+=m[e];y+=m[e+1]}m=(m.length-2)*2;return[o/m<<0,y/m<<0]}function La(m){var o=m.length/2,y=new Ma(o),e=0,h=o-1,i,q,n,H,K=[],R=[],J=[];for(y[e]=y[h]=1;h;){q=0;for(i=e+1;i<h;i++){n=m[i*2];var fa=m[i*2+1],E=m[e*2],P=m[e*2+1],$=m[h*2],M=m[h*2+1],v=$-E,B=M-P,F=void 0;if(v!==0||B!==0){F=((n-E)*v+(fa-P)*B)/(v*v+B*B);if(F>1){E=$;P=M}else if(F>0){E+=v*F;P+=B*F}}v=n-E;B=fa-P;n=v*
v+B*B;if(n>q){H=i;q=n}}if(q>2){y[H]=1;K.push(e);R.push(H);K.push(H);R.push(h)}e=K.pop();h=R.pop()}for(i=0;i<o;i++)y[i]&&J.push(m[i*2],m[i*2+1]);return J}var Na=Na||Array,Ma=Ma||Array,ba=Math,Qa=ba.exp,Ra=ba.log,Sa=ba.sin,Ta=ba.cos,Da=ba.tan,Ua=ba.atan,ka=ba.min,Ea=ba.max,va=k.document,S=function(){function m(e,h,i){if(i<0)i+=1;if(i>1)i-=1;if(i<1/6)return e+(h-e)*6*i;if(i<0.5)return h;if(i<2/3)return e+(h-e)*(2/3-i)*6;return e}function o(e,h,i,q){this.r=e;this.g=h;this.b=i;this.a=arguments.length<
4?1:q}var y=o.prototype;y.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+")"};y.adjustLightness=function(e){var h=S.toHSLA(this);h.l*=e;h.l=Math.min(1,Math.max(0,h.l));var i,q;if(h.s===0)e=i=q=h.l;else{q=h.l<0.5?h.l*(1+h.s):h.l+h.s-h.l*h.s;var n=2*h.l-q;e=m(n,q,h.h+1/3);i=m(n,q,h.h);q=m(n,q,h.h-1/3)}return new S(e*255<<0,i*255<<0,q*255<<0,h.a)};y.adjustAlpha=function(e){return new S(this.r,this.g,this.b,this.a*e)};o.parse=function(e){e+="";if(~e.indexOf("#")){e=
e.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new S(parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16),e[4]?parseInt(e[4],16)/255:1)}if(e=e.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new S(parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10),e[4]?parseFloat(e[5],10):1)};o.toHSLA=function(e){var h=e.r/255,i=e.g/255,q=e.b/255,n=Math.max(h,i,q),H=Math.min(h,i,q),K,R=(n+H)/2,J;if(n===H)K=H=0;else{J=n-H;H=R>0.5?J/(2-n-H):J/(n+H);switch(n){case h:K=(i-q)/J+(i<q?6:0);break;case i:K=
(q-h)/J+2;break;case q:K=(h-i)/J+4;break}K/=6}return{h:K,s:H,l:R,a:e.a}};return o}(),Va=function(){var m=Math,o=m.sin,y=m.cos,e=m.tan,h=m.asin,i=m.atan2,q=m.PI,n=180/q,H=357.5291/n,K=0.98560028/n,R=1.9148/n,J=0.02/n,fa=3.0E-4/n,E=102.9372/n,P=23.45/n,$=280.16/n,M=360.9856235/n;return function(v,B,F){F=-F/n;B=B/n;v=v.valueOf()/864E5-0.5+2440588;var D=H+K*(v-2451545),G=R*o(D)+J*o(2*D)+fa*o(3*D);G=D+E+G+q;D=h(o(G)*o(P));G=i(o(G)*y(P),y(G));F=$+M*(v-2451545)-F-G;return{altitude:h(o(B)*o(D)+y(B)*y(D)*
y(F)),azimuth:i(o(F),y(F)*o(B)-e(D)*y(B))-q/2}}}(),la=Math.PI,Oa=la/2,Wa=la/4,Xa=180/la,Ya=256,Fa=14,ma="latitude",na="longitude",W=0,Q=1,T=2,ca=3,wa=4,oa=5,aa=6;k.OSMBuildings=function(m){function o(a,c){var b={};a/=pa;c/=pa;b[ma]=c<=0?90:c>=1?-90:Xa*(2*Ua(Qa(la*(1-2*c)))-Oa);b[na]=(a===1?1:(a%1+1)%1)*360-180;return b}function y(a,c){return a.replace(/\{ *([\w_]+) *\}/g,function(b,d){return c[d]})}function e(a,c,b,d,g){a=ka(Ea(a,c),b);return ka(Ea(d+(a-c)/(b-c)*(g-d),d),g)}function h(a,c){var b=
new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||b.status>299||b.responseText&&c(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);return b}function i(){if(!(!Ga||U<Fa)){var a=o(D-B,G-F),c=o(D+M+B,G+v+F);xa&&xa.abort();xa=h(y(Ga,{w:a[na],n:a[ma],e:c[na],s:c[ma],z:U}),q)}}function q(a){var c,b,d,g=[],f,j=f=0;ya=Fa;J(U);xa=null;if(!(!a||a.meta.z!==U)){d=a.meta;b=a.data;if(I&&C&&I.z===d.z){f=I.x-d.x;j=I.y-d.y;a=0;for(c=C.length;a<c;a++)g[a]=C[a][T][0]+
f+","+(C[a][T][1]+j)}I=d;C=[];a=0;for(c=b.length;a<c;a++){d=[];if(!(b[a][Q]>qa)){f=La(b[a][T]);if(!(f.length<8)){d[T]=f;d[wa]=Ka(f);d[W]=ka(b[a][W],qa);d[Q]=b[a][Q];f=d[T][0]+","+d[T][1];d[oa]=!(g&&~g.indexOf(f));d[ca]=[];d[aa]=[];C.push(d)}}}fa()}}function n(a,c){var b=[],d,g,f,j,l,r,w,z,s,x=Ha-U;d=0;for(g=a.length;d<g;d++){l=a[d];z=l[Q]>>x;if(!(z>qa)){r=l[T];s=new Na(r.length);f=0;for(j=r.length-1;f<j;f+=2){w=r[f+1];var t=ka(1,Ea(0,0.5-Ra(Da(Wa+Oa*r[f]/180))/la/2));w={x:(w/360+0.5)*pa<<0,y:t*pa<<
0};s[f]=w.x;s[f+1]=w.y}s=La(s);if(!(s.length<8)){j=[];j[T]=s;j[wa]=Ka(s);j[W]=ka(l[W]>>x,qa);j[Q]=z;j[oa]=c;j[ca]=l[ca];j[aa]=[];for(f=0;f<3;f++)if(j[ca][f])j[aa][f]=j[ca][f].adjustAlpha(V)+"";b.push(j)}}}return b}function H(a,c){if(typeof a==="object")R(a,!c);else{var b=va.documentElement,d=va.createElement("script");k.jsonpCallback=function(g){delete k.jsonpCallback;b.removeChild(d);R(g,!c)};b.insertBefore(d,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function K(a,c,b){if(b===undefined)b=
[];var d,g,f,j=a[0]?a:a.features,l,r,w,z,s,x=c?1:0,t=c?0:1;if(j){d=0;for(a=j.length;d<a;d++)K(j[d],c,b);return b}if(a.type==="Feature"){l=a.geometry;d=a.properties}if(l.type==="Polygon")r=[l.coordinates];if(l.type==="MultiPolygon")r=l.coordinates;if(r){c=d.height;if(d.color||d.wallColor)z=S.parse(d.color||d.wallColor);if(d.roofColor)s=S.parse(d.roofColor);d=0;for(a=r.length;d<a;d++){j=r[d][0];w=[];g=l=0;for(f=j.length;g<f;g++){w.push(j[g][x],j[g][t]);l+=c||j[g][2]||0}if(l){g=[];f=T;var u=void 0,A=
void 0,N=void 0,ha=void 0,ra=0,X=void 0,Pa=void 0;X=0;for(Pa=w.length-3;X<Pa;X+=2){u=w[X];A=w[X+1];N=w[X+2];ha=w[X+3];ra+=u*ha-N*A}if((ra/2>0?"CW":"CCW")==="CW")w=w;else{u=[];for(A=w.length-2;A>=0;A-=2)u.push(w[A],w[A+1]);w=u}g[f]=w;g[W]=l/j.length<<0;g[ca]=[z||null,z?z.adjustLightness(0.8):null,s?s:z?z.adjustLightness(1.2):ga];b.push(g)}}}return b}function R(a,c){if(a){sa=K(a,c);ya=0;J(U);I={n:90,w:-180,s:-90,e:180,x:0,y:0,z:U};C=n(sa,true);fa()}else{sa=null;E()}}function J(a){var c,b,d;U=a;pa=Ya<<
U;V=1-e(U,ya,Ha,0,0.3);za=da.adjustAlpha(V)+"";Aa=Ba.adjustAlpha(V)+"";Ca=ga.adjustAlpha(V)+"";ea.colorStr=ea.color.adjustAlpha(V)+"";if(C){a=0;for(c=C.length;a<c;a++){d=C[a];d[aa]=[];for(b=0;b<3;b++)if(d[ca][b])d[aa][b]=d[ca][b].adjustAlpha(V)+""}}}function fa(){ia=0;ea.create();clearInterval(Ia);Ia=setInterval(function(){ia+=0.1;if(ia>1){clearInterval(Ia);ia=1;for(var a=0,c=C.length;a<c;a++)C[a][oa]=0}E()},33)}function E(){p.clearRect(0,0,M,v);if(I&&C)if(!(U<ya||Ja)){var a,c,b,d,g,f,j,l,r,w=D-I.x,
z=G-I.y,s=[ta+w,ua+z],x,t,u,A,N,ha;ea.render();C.sort(function(ra,X){return O(X[wa],s)/X[W]-O(ra[wa],s)/ra[W]});a=0;for(c=C.length;a<c;a++){g=C[a];t=false;f=g[T];x=[];b=0;for(d=f.length-1;b<d;b+=2){x[b]=l=f[b]-w;x[b+1]=r=f[b+1]-z;t||(t=l>0&&l<M&&r>0&&r<v)}if(t){b=g[oa]?g[W]*ia:g[W];f=ja/(ja-b);if(g[Q]){b=g[oa]?g[Q]*ia:g[Q];j=ja/(ja-b)}l=[];b=0;for(d=x.length-3;b<d;b+=2){r=x[b];u=x[b+1];t=x[b+2];A=x[b+3];N=$(r,u,f);ha=$(t,A,f);if(g[Q]){u=$(r,u,j);A=$(t,A,j);r=u.x;u=u.y;t=A.x;A=A.y}if((t-r)*(N.y-u)>
(N.x-r)*(A-u)){p.fillStyle=r<t&&u<A||r>t&&u>A?g[aa][1]||Aa:g[aa][0]||za;P([t,A,r,u,N.x,N.y,ha.x,ha.y])}l[b]=N.x;l[b+1]=N.y}p.fillStyle=g[aa][2]||Ca;p.strokeStyle=g[aa][1]||Aa;P(l,true)}}}}function P(a,c){if(a.length){p.beginPath();p.moveTo(a[0],a[1]);for(var b=2,d=a.length;b<d;b+=2)p.lineTo(a[b],a[b+1]);p.closePath();c&&p.stroke();p.fill()}}function $(a,c,b){return{x:(a-ta)*b+ta<<0,y:(c-ua)*b+ua<<0}}var M=0,v=0,B=0,F=0,D=0,G=0,U,pa,xa,Y,Z,p,Ga,da=new S(200,190,180),Ba=da.adjustLightness(0.8),ga=da.adjustLightness(1.2),
za=da+"",Aa=Ba+"",Ca=ga+"",sa,I,C,ia=1,Ia,V=1,ya=Fa,Ha=20,qa,ta,ua,ja,Ja,ea={enabled:true,originX:0,originY:0,buffer:new Image,color:new S(0,0,0),colorStr:this.color+"",sunAlpha:1,length:0,directionX:0,directionY:0,create:function(){if(I&&C)if(this.length){var a,c,b,d,g,f,j,l,r=D-I.x,w=G-I.y,z,s,x,t,u,A,N=[];p.fillStyle=this.colorStr;a=0;for(c=C.length;a<c;a++){g=C[a];s=false;f=g[T];z=[];b=0;for(d=f.length-1;b<d;b+=2){z[b]=j=f[b]-r;z[b+1]=l=f[b+1]-w;s||(s=j>0&&j<M&&l>0&&l<v)}if(s){f=g[W];if(g[Q])f=
g[Q];j=null;p.beginPath();b=0;for(d=z.length-3;b<d;b+=2){l=z[b];x=z[b+1];s=z[b+2];t=z[b+3];u=this.project(l,x,f);A=this.project(s,t,f);if(g[Q]){x=this.project(l,x,f);t=this.project(s,t,f);l=x.x;x=x.y;s=t.x;t=t.y}if((s-l)*(u.y-x)>(u.x-l)*(t-x)){j===1&&p.lineTo(l,x);j=0;b||p.moveTo(l,x);p.lineTo(s,t)}else{j===0&&p.lineTo(u.x,u.y);j=1;b||p.moveTo(u.x,u.y);p.lineTo(A.x,A.y)}}p.closePath();p.fill();N.push(z)}}p.fillStyle=za;a=0;for(c=N.length;a<c;a++)P(N[a]);this.filter();this.buffer.onload=function(){E()};
this.buffer.src=Z.toDataURL();this.originX=D;this.originY=G}},project:function(a,c,b){return{x:a+this.directionX*b,y:c+this.directionY*b}},filter:function(){for(var a=p.getImageData(0,0,M,v),c=a.data,b=this.sunAlpha*255<<0,d,g,f=0,j=c.length;f<j;f+=4){d=c[f+0];g=c[f+3];if(d&&g>=255)c[f+3]=0;else if(g>b)c[f+3]=b}p.putImageData(a,0,0)},render:function(){this.enabled&&this.length&&p.drawImage(this.buffer,this.originX-D,this.originY-G)},setSun:function(a){if(a.altitude<=0){this.length=0;this.sunAlpha=
e(-a.altitude,0,1,0.2,0.7)}else{this.length=1/Da(a.altitude);this.sunAlpha=0.4/this.length;this.directionX=Ta(a.azimuth)*this.length;this.directionY=Sa(a.azimuth)*this.length}this.color.a=this.sunAlpha;this.colorStr=this.color+"";this.create()}};this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){da=S.parse(a.color||a.wallColor);za=da.adjustAlpha(V)+"";Ba=da.adjustLightness(0.8);Aa=Ba.adjustAlpha(V)+"";ga=da.adjustLightness(1.2);Ca=ga.adjustAlpha(V)+""}if(a.roofColor){ga=S.parse(a.roofColor);
Ca=ga.adjustAlpha(V)+""}if(a.shadows!==undefined)ea.enabled=!!a.shadows;E();return this};this.geoJSON=function(a,c){H(a,c);return this};this.setCamOffset=function(a,c){ta=B+a;ua=v+c};this.setMaxZoom=function(a){Ha=a};this.setDate=function(a){var c=o(D+B,G+F);ea.setSun(Va(a,c.latitude,c.longitude));E();return this};this.createContainer=function(a){Y=va.createElement("DIV");Y.style.pointerEvents="none";Y.style.position="absolute";Y.style.left=0;Y.style.top=0;Z=va.createElement("CANVAS");Z.style.webkitTransform=
"translate3d(0,0,0)";Z.style.imageRendering="optimizeSpeed";Y.appendChild(Z);p=Z.getContext("2d");p.lineCap="round";p.lineJoin="round";p.lineWidth=1;try{p.mozImageSmoothingEnabled=false}catch(c){}a.appendChild(Y);return Y};this.destroyContainer=function(){Z.parentNode.removeChild(Z)};this.loadData=i;this.onMoveEnd=function(){var a=o(D,G),c=o(D+M,G+v);ea.create();E();if(I&&(a[ma]>I.n||a[na]<I.w||c[ma]<I.s||c[na]>I.e))i()};this.onZoomEnd=function(a){Ja=false;J(a.zoom);if(sa){C=n(sa);ea.create();E()}else{E();
i()}};this.onZoomStart=function(){Ja=true;E()};this.render=E;this.setOrigin=function(a,c){D=a;G=c};this.setSize=function(a,c){M=a;v=c;B=M/2<<0;F=v/2<<0;ta=B;ua=v;ja=M/1.5/Da(45)<<0;Y.width=M;Y.height=v;Z.width="100%";Z.height="100%";qa=ja-50};this.setZoom=J;Ga=m};k.OSMBuildings.VERSION="0.1.8a";k.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,container:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(k){L.Util.setOptions(this,k)},onMove:function(){var k=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-k.x,this.lastY-k.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=false;else{var k=L.DomUtil.getPosition(this.map._mapPane),O=this.map.getPixelOrigin();this.lastX=k.x;this.lastY=k.y;this.container.style.left=-k.x+
"px";this.container.style.top=-k.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(O.x-k.x,O.y-k.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var k=L.DomUtil.getPosition(this.map._mapPane),O=this.map.getPixelOrigin();this.osmb.setOrigin(O.x-k.x,O.y-k.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=true},addTo:function(k){k.addLayer(this);return this},onAdd:function(k){this.map=
k;this.osmb=new OSMBuildings(this.options.url);this.container=this.osmb.createContainer(this.map._panes.overlayPane);this.osmb.maxZoom=this.map._layersMaxZoom;k=L.DomUtil.getPosition(this.map._mapPane);var O=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(O.x-k.x,O.y-k.y);this.osmb.setZoom(this.map._zoom);this.container.style.left=-k.x+"px";this.container.style.top=-k.y+"px";this.map.on({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,
zoomend:this.onZoomEnd},this);this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.loadData();this.osmb.render()},onRemove:function(k){k.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);k.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.container=this.osmb.destroyContainer();this.osmb=this.map=null},geoJSON:function(k,O){return this.osmb.geoJSON(k,O)},setStyle:function(k){return this.osmb.setStyle(k)},
setDate:function(k){return this.osmb.setDate(k)}});
