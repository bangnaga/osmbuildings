(function(n){function N(l,o){var y=l[0]-o[0],e=l[1]-o[1];return y*y+e*e}function O(l){for(var o=0,y=0,e=0,h=l.length-3;e<h;e+=2){o+=l[e];y+=l[e+1]}l=(l.length-2)*2;return[o/l<<0,y/l<<0]}function va(l){var o=l.length/2,y=new La(o),e=0,h=o-1,i,q,m,H,K=[],R=[],J=[];for(y[e]=y[h]=1;h;){q=0;for(i=e+1;i<h;i++){m=l[i*2];var fa=l[i*2+1],E=l[e*2],P=l[e*2+1],$=l[h*2],L=l[h*2+1],v=$-E,B=L-P,F=void 0;if(v!==0||B!==0){F=((m-E)*v+(fa-P)*B)/(v*v+B*B);if(F>1){E=$;P=L}else if(F>0){E+=v*F;P+=B*F}}v=m-E;B=fa-P;m=v*
v+B*B;if(m>q){H=i;q=m}}if(q>2){y[H]=1;K.push(e);R.push(H);K.push(H);R.push(h)}e=K.pop();h=R.pop()}for(i=0;i<o;i++)y[i]&&J.push(l[i*2],l[i*2+1]);return J}var Ma=Ma||Array,La=La||Array,ba=Math,Pa=ba.exp,Qa=ba.log,Ra=ba.sin,Sa=ba.cos,Ea=ba.tan,Ta=ba.atan,ka=ba.min,Fa=ba.max,wa=n.document,S=function(){function l(e,h,i){if(i<0)i+=1;if(i>1)i-=1;if(i<1/6)return e+(h-e)*6*i;if(i<0.5)return h;if(i<2/3)return e+(h-e)*(2/3-i)*6;return e}function o(e,h,i,q){this.r=e;this.g=h;this.b=i;this.a=arguments.length<
4?1:q}var y=o.prototype;y.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+")"};y.adjustLightness=function(e){var h=S.toHSLA(this);h.l*=e;h.l=Math.min(1,Math.max(0,h.l));var i,q;if(h.s===0)e=i=q=h.l;else{q=h.l<0.5?h.l*(1+h.s):h.l+h.s-h.l*h.s;var m=2*h.l-q;e=l(m,q,h.h+1/3);i=l(m,q,h.h);q=l(m,q,h.h-1/3)}return new S(e*255<<0,i*255<<0,q*255<<0,h.a)};y.adjustAlpha=function(e){return new S(this.r,this.g,this.b,this.a*e)};o.parse=function(e){e+="";if(~e.indexOf("#")){e=
e.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new S(parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16),e[4]?parseInt(e[4],16)/255:1)}if(e=e.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new S(parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10),e[4]?parseFloat(e[5],10):1)};o.toHSLA=function(e){var h=e.r/255,i=e.g/255,q=e.b/255,m=Math.max(h,i,q),H=Math.min(h,i,q),K,R=(m+H)/2,J;if(m===H)K=H=0;else{J=m-H;H=R>0.5?J/(2-m-H):J/(m+H);switch(m){case h:K=(i-q)/J+(i<q?6:0);break;case i:K=
(q-h)/J+2;break;case q:K=(h-i)/J+4;break}K/=6}return{h:K,s:H,l:R,a:e.a}};return o}(),Ua=function(){var l=Math,o=l.sin,y=l.cos,e=l.tan,h=l.asin,i=l.atan2,q=l.PI,m=180/q,H=357.5291/m,K=0.98560028/m,R=1.9148/m,J=0.02/m,fa=3.0E-4/m,E=102.9372/m,P=23.45/m,$=280.16/m,L=360.9856235/m;return function(v,B,F){F=-F/m;B=B/m;v=v.valueOf()/864E5-0.5+2440588;var D=H+K*(v-2451545),G=R*o(D)+J*o(2*D)+fa*o(3*D);G=D+E+G+q;D=h(o(G)*o(P));G=i(o(G)*y(P),y(G));F=$+L*(v-2451545)-F-G;return{altitude:h(o(B)*o(D)+y(B)*y(D)*
y(F)),azimuth:i(o(F),y(F)*o(B)-e(D)*y(B))-q/2}}}(),la=Math.PI,Na=la/2,Va=la/4,Wa=180/la,Xa=256,Ga=14,ma="latitude",na="longitude",W=0,Q=1,T=2,ca=3,xa=4,oa=5,aa=6;n.OSMBuildings=function(l){function o(a,c){var b={};a/=pa;c/=pa;b[ma]=c<=0?90:c>=1?-90:Wa*(2*Ta(Pa(la*(1-2*c)))-Na);b[na]=(a===1?1:(a%1+1)%1)*360-180;return b}function y(a,c){return a.replace(/\{ *([\w_]+) *\}/g,function(b,d){return c[d]})}function e(a,c,b,d,g){a=ka(Fa(a,c),b);return ka(Fa(d+(a-c)/(b-c)*(g-d),d),g)}function h(a,c){var b=
new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||b.status>299||b.responseText&&c(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);return b}function i(){if(!(!Ha||U<Ga)){var a=o(D-B,G-F),c=o(D+L+B,G+v+F);ya&&ya.abort();ya=h(y(Ha,{w:a[na],n:a[ma],e:c[na],s:c[ma],z:U}),q)}}function q(a){var c,b,d,g=[],f,j=f=0;za=Ga;J(U);ya=null;if(!(!a||a.meta.z!==U)){d=a.meta;b=a.data;if(I&&C&&I.z===d.z){f=I.x-d.x;j=I.y-d.y;a=0;for(c=C.length;a<c;a++)g[a]=C[a][T][0]+
f+","+(C[a][T][1]+j)}I=d;C=[];a=0;for(c=b.length;a<c;a++){d=[];if(!(b[a][Q]>qa)){f=va(b[a][T]);if(!(f.length<8)){d[T]=f;d[xa]=O(f);d[W]=ka(b[a][W],qa);d[Q]=b[a][Q];f=d[T][0]+","+d[T][1];d[oa]=!(g&&~g.indexOf(f));d[ca]=[];d[aa]=[];C.push(d)}}}fa()}}function m(a,c){var b=[],d,g,f,j,k,r,w,z,s,x=Ia-U;d=0;for(g=a.length;d<g;d++){k=a[d];z=k[Q]>>x;if(!(z>qa)){r=k[T];s=new Ma(r.length);f=0;for(j=r.length-1;f<j;f+=2){w=r[f+1];var t=ka(1,Fa(0,0.5-Qa(Ea(Va+Na*r[f]/180))/la/2));w={x:(w/360+0.5)*pa<<0,y:t*pa<<
0};s[f]=w.x;s[f+1]=w.y}s=va(s);if(!(s.length<8)){j=[];j[T]=s;j[xa]=O(s);j[W]=ka(k[W]>>x,qa);j[Q]=z;j[oa]=c;j[ca]=k[ca];j[aa]=[];for(f=0;f<3;f++)if(j[ca][f])j[aa][f]=j[ca][f].adjustAlpha(V)+"";b.push(j)}}}return b}function H(a,c){if(typeof a==="object")R(a,!c);else{var b=wa.documentElement,d=wa.createElement("script");n.jsonpCallback=function(g){delete n.jsonpCallback;b.removeChild(d);R(g,!c)};b.insertBefore(d,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function K(a,c,b){if(b===undefined)b=
[];var d,g,f,j=a[0]?a:a.features,k,r,w,z,s,x=c?1:0,t=c?0:1;if(j){d=0;for(a=j.length;d<a;d++)K(j[d],c,b);return b}if(a.type==="Feature"){k=a.geometry;d=a.properties}if(k.type==="Polygon")r=[k.coordinates];if(k.type==="MultiPolygon")r=k.coordinates;if(r){c=d.height;if(d.color||d.wallColor)z=S.parse(d.color||d.wallColor);if(d.roofColor)s=S.parse(d.roofColor);d=0;for(a=r.length;d<a;d++){j=r[d][0];w=[];g=k=0;for(f=j.length;g<f;g++){w.push(j[g][x],j[g][t]);k+=c||j[g][2]||0}if(k){g=[];f=T;var u=void 0,A=
void 0,M=void 0,ha=void 0,ra=0,X=void 0,Oa=void 0;X=0;for(Oa=w.length-3;X<Oa;X+=2){u=w[X];A=w[X+1];M=w[X+2];ha=w[X+3];ra+=u*ha-M*A}if((ra/2>0?"CW":"CCW")==="CW")w=w;else{u=[];for(A=w.length-2;A>=0;A-=2)u.push(w[A],w[A+1]);w=u}g[f]=w;g[W]=k/j.length<<0;g[ca]=[z||null,z?z.adjustLightness(0.8):null,s?s:z?z.adjustLightness(1.2):ga];b.push(g)}}}return b}function R(a,c){if(a){sa=K(a,c);za=0;J(U);I={n:90,w:-180,s:-90,e:180,x:0,y:0,z:U};C=m(sa,true);fa()}else{sa=null;E()}}function J(a){var c,b,d;U=a;pa=Xa<<
U;V=1-e(U,za,Ia,0,0.3);Aa=da.adjustAlpha(V)+"";Ba=Ca.adjustAlpha(V)+"";Da=ga.adjustAlpha(V)+"";ea.colorStr=ea.color.adjustAlpha(V)+"";if(C){a=0;for(c=C.length;a<c;a++){d=C[a];d[aa]=[];for(b=0;b<3;b++)if(d[ca][b])d[aa][b]=d[ca][b].adjustAlpha(V)+""}}}function fa(){ia=0;ea.create();clearInterval(Ja);Ja=setInterval(function(){ia+=0.1;if(ia>1){clearInterval(Ja);ia=1;for(var a=0,c=C.length;a<c;a++)C[a][oa]=0}E()},33)}function E(){p.clearRect(0,0,L,v);if(I&&C)if(!(U<za||Ka)){var a,c,b,d,g,f,j,k,r,w=D-I.x,
z=G-I.y,s=[ta+w,ua+z],x,t,u,A,M,ha;ea.render();C.sort(function(ra,X){return N(X[xa],s)/X[W]-N(ra[xa],s)/ra[W]});a=0;for(c=C.length;a<c;a++){g=C[a];t=false;f=g[T];x=[];b=0;for(d=f.length-1;b<d;b+=2){x[b]=k=f[b]-w;x[b+1]=r=f[b+1]-z;t||(t=k>0&&k<L&&r>0&&r<v)}if(t){b=g[oa]?g[W]*ia:g[W];f=ja/(ja-b);if(g[Q]){b=g[oa]?g[Q]*ia:g[Q];j=ja/(ja-b)}k=[];b=0;for(d=x.length-3;b<d;b+=2){r=x[b];u=x[b+1];t=x[b+2];A=x[b+3];M=$(r,u,f);ha=$(t,A,f);if(g[Q]){u=$(r,u,j);A=$(t,A,j);r=u.x;u=u.y;t=A.x;A=A.y}if((t-r)*(M.y-u)>
(M.x-r)*(A-u)){p.fillStyle=r<t&&u<A||r>t&&u>A?g[aa][1]||Ba:g[aa][0]||Aa;P([t,A,r,u,M.x,M.y,ha.x,ha.y])}k[b]=M.x;k[b+1]=M.y}p.fillStyle=g[aa][2]||Da;p.strokeStyle=g[aa][1]||Ba;P(k,true)}}}}function P(a,c){if(a.length){p.beginPath();p.moveTo(a[0],a[1]);for(var b=2,d=a.length;b<d;b+=2)p.lineTo(a[b],a[b+1]);p.closePath();c&&p.stroke();p.fill()}}function $(a,c,b){return{x:(a-ta)*b+ta<<0,y:(c-ua)*b+ua<<0}}var L=0,v=0,B=0,F=0,D=0,G=0,U,pa,ya,Y,Z,p,Ha,da=new S(200,190,180),Ca=da.adjustLightness(0.8),ga=da.adjustLightness(1.2),
Aa=da+"",Ba=Ca+"",Da=ga+"",sa,I,C,ia=1,Ja,V=1,za=Ga,Ia=20,qa,ta,ua,ja,Ka,ea={enabled:true,originX:0,originY:0,buffer:new Image,color:new S(0,0,0),colorStr:this.color+"",sunAlpha:1,length:0,directionX:0,directionY:0,create:function(){if(I&&C)if(this.length){var a,c,b,d,g,f,j,k,r=D-I.x,w=G-I.y,z,s,x,t,u,A,M=[];p.fillStyle=this.colorStr;a=0;for(c=C.length;a<c;a++){g=C[a];s=false;f=g[T];z=[];b=0;for(d=f.length-1;b<d;b+=2){z[b]=j=f[b]-r;z[b+1]=k=f[b+1]-w;s||(s=j>0&&j<L&&k>0&&k<v)}if(s){f=g[W];if(g[Q])f=
g[Q];j=null;p.beginPath();b=0;for(d=z.length-3;b<d;b+=2){k=z[b];x=z[b+1];s=z[b+2];t=z[b+3];u=this.project(k,x,f);A=this.project(s,t,f);if(g[Q]){x=this.project(k,x,f);t=this.project(s,t,f);k=x.x;x=x.y;s=t.x;t=t.y}if((s-k)*(u.y-x)>(u.x-k)*(t-x)){j===1&&p.lineTo(k,x);j=0;b||p.moveTo(k,x);p.lineTo(s,t)}else{j===0&&p.lineTo(u.x,u.y);j=1;b||p.moveTo(u.x,u.y);p.lineTo(A.x,A.y)}}p.closePath();p.fill();M.push(z)}}p.fillStyle=Aa;a=0;for(c=M.length;a<c;a++)P(M[a]);this.filter();this.buffer.onload=function(){E()};
this.buffer.src=Z.toDataURL();this.originX=D;this.originY=G}},project:function(a,c,b){return{x:a+this.directionX*b,y:c+this.directionY*b}},filter:function(){for(var a=p.getImageData(0,0,L,v),c=a.data,b=this.sunAlpha*255<<0,d,g,f=0,j=c.length;f<j;f+=4){d=c[f+0];g=c[f+3];if(d&&g>=255)c[f+3]=0;else if(g>b)c[f+3]=b}p.putImageData(a,0,0)},render:function(){this.enabled&&this.length&&p.drawImage(this.buffer,this.originX-D,this.originY-G)},setSun:function(a){if(a.altitude<=0){this.length=0;this.sunAlpha=
e(-a.altitude,0,1,0.2,0.7)}else{this.length=1/Ea(a.altitude);this.sunAlpha=0.4/this.length;this.directionX=Sa(a.azimuth)*this.length;this.directionY=Ra(a.azimuth)*this.length}this.color.a=this.sunAlpha;this.colorStr=this.color+"";this.create()}};this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){da=S.parse(a.color||a.wallColor);Aa=da.adjustAlpha(V)+"";Ca=da.adjustLightness(0.8);Ba=Ca.adjustAlpha(V)+"";ga=da.adjustLightness(1.2);Da=ga.adjustAlpha(V)+""}if(a.roofColor){ga=S.parse(a.roofColor);
Da=ga.adjustAlpha(V)+""}if(a.shadows!==undefined)ea.enabled=!!a.shadows;E();return this};this.geoJSON=function(a,c){H(a,c);return this};this.setCamOffset=function(a,c){ta=B+a;ua=v+c};this.setMaxZoom=function(a){Ia=a};this.setDate=function(a){var c=o(D+B,G+F);ea.setSun(Ua(a,c.latitude,c.longitude));E();return this};this.createContainer=function(a){Y=wa.createElement("DIV");Y.style.pointerEvents="none";Y.style.position="absolute";Y.style.left=0;Y.style.top=0;Z=wa.createElement("CANVAS");Z.style.webkitTransform=
"translate3d(0,0,0)";Z.style.imageRendering="optimizeSpeed";Y.appendChild(Z);p=Z.getContext("2d");p.lineCap="round";p.lineJoin="round";p.lineWidth=1;try{p.mozImageSmoothingEnabled=false}catch(c){}a.appendChild(Y);return Y};this.destroyContainer=function(){Z.parentNode.removeChild(Z)};this.loadData=i;this.onMoveEnd=function(){var a=o(D,G),c=o(D+L,G+v);ea.create();E();if(I&&(a[ma]>I.n||a[na]<I.w||c[ma]<I.s||c[na]>I.e))i()};this.onZoomEnd=function(a){Ka=false;J(a.zoom);if(sa){C=m(sa);ea.create();E()}else{E();
i()}};this.onZoomStart=function(){Ka=true;E()};this.render=E;this.setOrigin=function(a,c){D=a;G=c};this.setSize=function(a,c){L=a;v=c;B=L/2<<0;F=v/2<<0;ta=B;ua=v;ja=L/1.5/Ea(45)<<0;Y.width=L;Y.height=v;Z.width="100%";Z.height="100%";qa=ja-50};this.setZoom=J;Ha=l};n.OSMBuildings.VERSION="0.1.8a";n.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:false,alwaysInRange:true,dxSum:0,dySum:0,initialize:function(n){n=n||{};n.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize(this.name,n)},setOrigin:function(){var n=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),N=this.map.resolution,O=this.maxExtent;this.osmb.setOrigin(Math.round((n.lon-O.left)/N),Math.round((O.top-
n.lat)/N))},setMap:function(n){if(!this.map){OpenLayers.Layer.prototype.setMap(n);this.osmb=new OSMBuildings(this.options.url);this.osmb.createContainer(this.div);this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin();this.osmb.loadData()}},removeMap:function(n){this.osmb.destroyContainer();this.osmb=null;OpenLayers.Layer.prototype.removeMap(n)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize();this.osmb.onResize({width:this.map.size.w,height:this.map.size.h})},
moveTo:function(n,N,O){n=OpenLayers.Layer.prototype.moveTo(n,N,O);if(!O){O=parseInt(this.map.layerContainerDiv.style.left,10);var va=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-O+"px";this.div.style.top=-va+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);N?this.osmb.onZoomEnd({zoom:this.map.zoom}):this.osmb.onMoveEnd();return n},moveByPx:function(n,N){this.dxSum+=n;this.dySum+=N;var O=OpenLayers.Layer.prototype.moveByPx(n,N);this.osmb.setCamOffset(this.dxSum,
this.dySum);this.osmb.render();return O},geoJSON:function(n,N){return this.osmb.geoJSON(n,N)},setStyle:function(n){return this.osmb.setStyle(n)},setDate:function(n){return this.osmb.setDate(n)}});
